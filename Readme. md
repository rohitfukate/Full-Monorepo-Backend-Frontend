#!/bin/bash
# Usage: ./create_full_monorepo_github.sh <github-username> <repo-name>
# Example: ./create_full_monorepo_github.sh rohitfukate inventory-management-system

USERNAME=$1
REPO_NAME=$2

if [ -z "$USERNAME" ] || [ -z "$REPO_NAME" ]; then
  echo "Error: Provide your GitHub username and desired repo name."
  echo "Usage: ./create_full_monorepo_github.sh <username> <repo-name>"
  exit 1
fi

# Check GitHub CLI
if ! command -v gh &> /dev/null; then
    echo "GitHub CLI not found. Install from https://cli.github.com/"
    exit 1
fi

echo "Creating Inventory Management System monorepo..."

# Create folder structure
mkdir -p inventory-management-system/backend/inventory/migrations
mkdir -p inventory-management-system/frontend/pages
mkdir -p inventory-management-system/frontend/services
mkdir -p inventory-management-system/frontend/styles
mkdir -p inventory-management-system/frontend/context

cd inventory-management-system || exit

# =======================
# Backend placeholder files
# =======================
cat <<EOL > backend/manage.py
#!/usr/bin/env python
import os
import sys
if __name__ == "__main__":
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "backend.settings")
    from django.core.management import execute_from_command_line
    execute_from_command_line(sys.argv)
EOL

cat <<EOL > backend/requirements.txt
django
djangorestframework
psycopg2-binary
django-cors-headers
djangorestframework-simplejwt
gunicorn
EOL

echo "# Django settings placeholder" > backend/backend/settings.py

cat <<EOL > backend/backend/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from inventory.views import ProductViewSet, dashboard
from inventory.auth_views import RegisterView
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView

router = DefaultRouter()
router.register('products', ProductViewSet)

urlpatterns = [
    path('api/', include(router.urls)),
    path('api/dashboard/', dashboard),
    path('api/auth/register/', RegisterView.as_view()),
    path('api/auth/login/', TokenObtainPairView.as_view()),
    path('api/auth/refresh/', TokenRefreshView.as_view()),
]
EOL

echo "# WSGI placeholder" > backend/backend/wsgi.py
echo "# ASGI placeholder" > backend/backend/asgi.py

# Models
cat <<EOL > backend/inventory/models.py
from django.db import models
from django.contrib.auth.models import User
class Product(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    quantity = models.IntegerField()
    created_at = models.DateTimeField(auto_now_add=True)
    def __str__(self):
        return self.name
EOL

# Serializers
cat <<EOL > backend/inventory/serializers.py
from rest_framework import serializers
from .models import Product
class ProductSerializer(serializers.ModelSerializer):
    class Meta:
        model = Product
        fields = '__all__'
EOL

# Views + Dashboard
cat <<EOL > backend/inventory/views.py
from rest_framework.viewsets import ModelViewSet
from rest_framework.filters import SearchFilter
from rest_framework.decorators import api_view
from rest_framework.response import Response
from .models import Product
from .serializers import ProductSerializer
from django.db.models import Sum

class ProductViewSet(ModelViewSet):
    serializer_class = ProductSerializer
    filter_backends = [SearchFilter]
    search_fields = ['name', 'description']

    def get_queryset(self):
        return Product.objects.filter(user=self.request.user)

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)

@api_view(['GET'])
def dashboard(request):
    user = request.user
    total_products = Product.objects.filter(user=user).count()
    total_inventory_value = Product.objects.filter(user=user).aggregate(total=Sum('price'))['total'] or 0
    top_products = Product.objects.filter(user=user).order_by('-quantity')[:5]
    top_products_data = [{"name": p.name, "quantity": p.quantity} for p in top_products]
    return Response({
        "total_products": total_products,
        "total_inventory_value": total_inventory_value,
        "top_products": top_products_data
    })
EOL

# Auth serializers
cat <<EOL > backend/inventory/auth_serializers.py
from django.contrib.auth.models import User
from rest_framework import serializers
class RegisterSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True)
    class Meta:
        model = User
        fields = ['username', 'email', 'password']
    def create(self, validated_data):
        user = User.objects.create_user(**validated_data)
        return user
EOL

# Auth views
cat <<EOL > backend/inventory/auth_views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .auth_serializers import RegisterSerializer
class RegisterView(APIView):
    permission_classes = []
    def post(self, request):
        serializer = RegisterSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response({"message": "User registered"}, status=status.HTTP_201_CREATED)
EOL

touch backend/inventory/migrations/__init__.py

# Backend README
cat <<EOL > backend/README.md
# Inventory Management Backend

## Setup

1. Create virtualenv:
   python -m venv venv
   source venv/bin/activate
2. Install requirements:
   pip install -r requirements.txt
3. Configure PostgreSQL / Supabase URL
4. Run migrations:
   python manage.py migrate
5. Start server:
   python manage.py runserver
EOL

# =======================
# Frontend
# =======================

# Dashboard context
cat <<EOL > frontend/context/DashboardContext.js
import { createContext, useState, useContext } from "react";
const DashboardContext = createContext();
export const DashboardProvider = ({ children }) => {
  const [refreshDashboard, setRefreshDashboard] = useState(0);
  const triggerRefresh = () => setRefreshDashboard(prev => prev + 1);
  return (
    <DashboardContext.Provider value={{ refreshDashboard, triggerRefresh }}>
      {children}
    </DashboardContext.Provider>
  );
};
export const useDashboard = () => useContext(DashboardContext);
EOL

# _app.js
cat <<EOL > frontend/pages/_app.js
import '../styles/globals.css';
import { DashboardProvider } from "../context/DashboardContext";
export default function App({ Component, pageProps }) {
  return (
    <DashboardProvider>
      <Component {...pageProps} />
    </DashboardProvider>
  );
}
EOL

# API
cat <<EOL > frontend/services/api.js
import axios from "axios";
const API = axios.create({ baseURL: process.env.NEXT_PUBLIC_API_URL });
API.interceptors.request.use(config => {
  const token = localStorage.getItem("token");
  if(token){ config.headers.Authorization = \`Bearer \${token}\`; }
  return config;
});
export default API;
EOL

# CRUD page with dashboard trigger
cat <<EOL > frontend/pages/index.js
import { useEffect, useState } from "react";
import API from "../services/api";
import { useDashboard } from "../context/DashboardContext";

export default function Home() {
  const { triggerRefresh } = useDashboard();
  const [products, setProducts] = useState([]);
  const [form, setForm] = useState({name:"", description:"", price:"", quantity:""});

  const load = async () => {
    const res = await API.get("products/");
    setProducts(res.data);
  };

  const create = async () => {
    await API.post("products/", form);
    setForm({name:"", description:"", price:"", quantity:""});
    load();
    triggerRefresh();
  };

  const update = async (p) => { await API.put(\`products/\${p.id}/\`, {...p, quantity: p.quantity + 1}); load(); triggerRefresh(); }
  const remove = async (id) => { await API.delete(\`products/\${id}/\`); load(); triggerRefresh(); }

  useEffect(() => { load(); }, []);

  return (
    <div className="min-h-screen bg-gray-100 p-6">
      <h1 className="text-3xl font-bold mb-6">Inventory Manager</h1>
      <div className="bg-white p-4 rounded shadow mb-6 flex flex-col gap-2 max-w-md">
        <input placeholder="Name" className="border p-2 rounded" onChange={e => setForm({...form, name:e.target.value})}/>
        <input placeholder="Description" className="border p-2 rounded" onChange={e => setForm({...form, description:e.target.value})}/>
        <input placeholder="Price" className="border p-2 rounded" onChange={e => setForm({...form, price:e.target.value})}/>
        <input placeholder="Quantity" className="border p-2 rounded" onChange={e => setForm({...form, quantity:e.target.value})}/>
        <button className="bg-blue-500 text-white p-2 rounded" onClick={create}>Add Product</button>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {products.map(p=>(
          <div key={p.id} className="bg-white p-4 rounded shadow flex justify-between items-center">
            <div>
              <h2 className="font-bold">{p.name}</h2>
              <p>{p.description}</p>
              <p className="text-gray-600">₹{p.price} | Qty: {p.quantity}</p>
            </div>
            <div className="flex gap-2">
              <button className="bg-green-500 text-white p-2 rounded" onClick={()=>update(p)}>Update</button>
              <button className="bg-red-500 text-white p-2 rounded" onClick={()=>remove(p.id)}>Delete</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
EOL

# Dashboard page
cat <<EOL > frontend/pages/dashboard.js
import { useEffect, useState } from "react";
import API from "../services/api";
import { BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid } from "recharts";
import { useDashboard } from "../context/DashboardContext";

export default function Dashboard() {
  const [data, setData] = useState({ total_products:0, total_inventory_value:0, top_products:[] });
  const { refreshDashboard } = useDashboard();

  const loadDashboard = async () => {
    const res = await API.get("dashboard/");
    setData(res.data);
  };

  useEffect(() => { loadDashboard(); }, [refreshDashboard]);

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">Inventory Dashboard</h1>
      <div className="flex gap-6 mb-6">
        <div className="bg-white p-4 rounded shadow w-1/3">
          <h2>Total Products</h2>
          <p className="text-3xl font-bold">{data.total_products}</p>
        </div>
        <div className="bg-white p-4 rounded shadow w-1/3">
          <h2>Total Inventory Value</h2>
          <p className="text-3xl font-bold">₹{data.total_inventory_value}</p>
        </div>
      </div>
      <div className="bg-white p-4 rounded shadow">
        <h2 className="mb-2">Top Products by Quantity</h2>
        <BarChart width={600} height={300} data={data.top_products}>
          <CartesianGrid stroke="#ccc" />
          <XAxis dataKey="name" />
          <YAxis />
          <Tooltip />
          <Bar dataKey="quantity" fill="#8884d8" />
        </BarChart>
      </div>
    </div>
  );
}
EOL

# Login page
cat <<EOL > frontend/pages/login.js
import { useState } from "react";
import API from "../services/api";
export default function Login() {
  const [data, setData] = useState({username:"", password:""});
  const login = async () => {
    const res = await API.post("auth/login/", data);
    localStorage.setItem("token", res.data.access);
    API.defaults.headers.common["Authorization"] = \`Bearer \${res.data.access}\`;
  };
  return (
    <div className="p-6">
      <input placeholder="Username" className="border p-2 rounded" onChange={e=>setData({...data, username:e.target.value})}/>
      <input placeholder="Password" type="password" className="border p-2 rounded" onChange={e=>setData({...data, password:e.target.value})}/>
      <button className="bg-blue-500 text-white p-2 rounded" onClick={login}>Login</button>
    </div>
  );
}
EOL

# Tailwind globals
echo "@tailwind base;\n@tailwind components;\n@tailwind utilities;" > frontend/styles/globals.css

# package.json
cat <<EOL > frontend/package.json
{
  "name": "frontend",
  "version": "1.0.0",
  "dependencies": {
    "axios": "^1.4.0",
    "next": "13.5.4",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "recharts": "2.7.2"
  },
  "scripts": { "dev": "next dev", "build": "next build", "start": "next start" }
}
EOL

# Tailwind + PostCSS
echo "module.exports = { content:['./pages/**/*.{js,ts,jsx,tsx}','./components/**/*.{js,ts,jsx,tsx}'], theme:{extend:{}}, plugins:[] };" > frontend/tailwind.config.js
echo "module.exports = { plugins:{ tailwindcss:{}, autoprefixer:{} } };" > frontend/postcss.config.js

# Frontend README
cat <<EOL > frontend/README.md
# Inventory Management Frontend

## Setup

1. Install dependencies:
   npm install
2. Set environment variable:
   NEXT_PUBLIC_API_URL=https://your-backend-url
3. Start dev server:
   npm run dev
EOL

# Root README
echo "# Inventory Management System Monorepo" > README.md

# .gitignore
cat <<EOL > .gitignore
node_modules/
*.env
__pycache__/
*.pyc
EOL

# =======================
# Initialize git and push to GitHub
# =======================
git init
git add .
git commit -m "Initial monorepo commit with backend + frontend + dashboard auto-refresh"
git branch -M main
gh repo create $USERNAME/$REPO_NAME --public --confirm
git remote add origin https://github.com/$USERNAME/$REPO_NAME.git
git push -u origin main

echo "✅ Monorepo created and pushed!"
echo "Repo link: https://github.com/$USERNAME/$REPO_NAME"
